var STALK_conf={httpUrl:"http://www.stalk.io",appUrl:"http://www.stalk.io:8080",serverInfo:{},divName:"STALK_SCREEN",refer:"",user:{},isLogined:false,sock:{},socketId:"",currentUserCnt:0,isEmptyMessage:true,defaultCloseWidth:"100px",defaultOpenWidth:"300px",defaultMaxOpenWidth:"500px"};var STALK_utils={getHashCode:function(b){var d=0;if(b.length===0){return d}for(var a=0;a<b.length;a++){var c=b.charCodeAt(a);d=((d<<5)-d)+c;d=d&d}return d},loadScript:function(b,c){var a=document.createElement("script");a.type="text/javascript";if(a.readyState){a.onreadystatechange=function(){if(a.readyState=="loaded"||a.readyState=="complete"){c()}}}else{a.onload=function(){c()}}a.src=b;document.getElementsByTagName("head")[0].appendChild(a)},loadCss:function(a){var b=document.createElement("link");b.type="text/css";b.rel="stylesheet";b.href=a;document.getElementsByTagName("head")[0].appendChild(b);return b},loadJson:function(b,c){var a=document.createElement("script");a.type="text/javascript";a.charset="utf-8";a.id=this.getHashCode(b);if(a.readyState){a.onreadystatechange=function(){if(a.readyState=="loaded"||a.readyState=="complete"){}}}else{a.onload=function(){}}a.src=b+"&callback="+c+"&_noCacheIE="+(new Date()).getTime();document.getElementsByTagName("head")[0].appendChild(a)},setUserInfo:function(a){document.cookie="STALK_USER="+escape(JSON.stringify(a))+";path=/"},delUserInfo:function(){var b=new Date();var a=-1;b.setDate(b.getDate()+a);document.cookie="STALK_USER=;expires="+b.toGMTString()+";path=/"},getUserInfo:function(){var c=document.cookie;var d=c.split("; ");for(var b=0;b<d.length;b++){var a=d[b].split("=");if(a[0]=="STALK_USER"){return JSON.parse(unescape(a[1]))}}return{}},userLog:function(){var c=document.cookie;var d=c.split("; ");for(var b=0;b<d.length;b++){var a=d[b].split("=");if(a[0]=="STALK"){}}return{}}};var STALK_window={rootDivName:"",imageServer:"",textareaHeight:-1,divCloseWidth:STALK_conf.defaultCloseWidth,divOpenWidth:STALK_conf.defaultOpenWidth,divMaxOpenWidth:STALK_conf.defaultMaxOpenWidth,currentSize:"MIN",isLogined:false,blinkTimeout:"",eventType:"",pageSize:{},hasClass:function(a,c){var b=new RegExp("(^|\\s)"+c+"(\\s|$)");return b.test(a.className)},addClass:function(b,a){if(!this.hasClass(b,a)){b.className+=" "+a}},removeClass:function(c,a){if(this.hasClass(c,a)){var b=new RegExp("(\\s|^)"+a+"(\\s|$)");c.className=c.className.replace(b," ")}},getBodySize:function(){var b=window,h=document,f=h.documentElement,c=h.getElementsByTagName("body")[0],a=b.innerWidth||f.clientWidth||c.clientWidth,i=b.innerHeight||f.clientHeight||c.clientHeight;return{width:a,height:i}},getStyle:function(a,b){if(a.currentStyle){return a.currentStyle[b]}else{if(document.defaultView&&document.defaultView.getComputedStyle){return document.defaultView.getComputedStyle(a,"")[b]}else{return a.style[b]}}},initWin:function(d,f){this.pageSize=this.getBodySize();this.rootDivName=d;this.imageServer=f;STALK_utils.loadCss(this.imageServer+"/stalk.css");var a=document.getElementById(d);if(a===null){a=document.createElement("div");a.id=d;a.style.bottom="0px";if(this.pageSize.width<=980){a.style.right="0px";a.style.width=this.divOpenWidth}else{a.style.right="100px";a.style.width=this.divOpenWidth}this.addClass(a,"stalk");document.getElementsByTagName("body")[0].appendChild(a)}this.divOpenWidth=this.getStyle(a,"width");a.innerHTML='<div id="'+d+'_head" onclick="javascript:return STALK_window.toggleChatBoxGrowth();" class="stalk_head" ><div id="'+d+'_title" class="stalk_title"></div><div id="'+d+'_options" class="stalk_options"></div><div id="'+d+'_size" class="stalk_options"></div><br clear="all"></div><div id="'+d+'_content" class="stalk_content"></div><div id="'+d+'_input" class="stalk_input"><textarea id="'+d+'_textarea" class="stalk_textarea" onkeydown="javascript:return STALK_window.inputChatMessage(event,this);" ></textarea></div><div id="'+d+'_login" class="stalk_login"><span align=right>CONNECT<br/>WITH</span> <a href="#" class="stalk_tooltip" title="login with facebook" onclick="return !window.open(STALK.getOauthUrl(\'facebook\'),\'STALK_OAUTH\',\'menubar=no,location=no,resizable=yes,scrollbars=yes,status=yes,width=350,height=350\')" target="_blank"><img src="'+this.imageServer+'/img/facebook.png" class="stalk_snsbtn" /></a>&nbsp;<a href="#" class="stalk_tooltip" title="login with twitter" onclick="return !window.open(STALK.getOauthUrl(\'twitter\'),\'STALK_OAUTH\',\'menubar=no,location=no,resizable=yes,scrollbars=yes,status=yes,width=700,height=450\')" target="_blank"><img src="'+this.imageServer+'/img/twitter.png" class="stalk_snsbtn" /></a>&nbsp;<a href="#" class="stalk_tooltip" title="login with google+" onclick="return !window.open(STALK.getOauthUrl(\'googleplus\'),\'STALK_OAUTH\',\'menubar=no,location=no,resizable=yes,scrollbars=yes,status=yes,width=800,height=450\')" target="_blank"><img src="'+this.imageServer+'/img/google.png" class="stalk_snsbtn" /></a>&nbsp;</div><div id="'+d+'_sitelink" class="stalk_sitelink"><a href="http://stalk.io" target="_blank">stalk.io</a></div>';var e=document.getElementById(d+"_content");var c=document.getElementById(d+"_login");var b=document.getElementById(d+"_input");a.onclick=function(){if(e.style.display!="none"){if(b.style.display!="none"){var g=document.getElementById(d+"_textarea");g.focus();g.value=g.value}}};a.style.display="none";if(this.pageSize.width<=980){document.getElementById(this.rootDivName+"_sitelink").style.right="10px"}else{document.getElementById(this.rootDivName+"_sitelink").style.right="110px"}this.toggleChatBoxGrowth()},showRootDiv:function(b){var a=document.getElementById(this.rootDivName);if(b){a.style.display="block"}else{a.style.display="none"}},isShowRootDiv:function(){var a=document.getElementById(this.rootDivName);if(a.style.display=="block"){return true}else{return false}},blinkHeader:function(a){if(a){clearInterval(this.blinkTimeout);var b=document.getElementById(this.rootDivName+"_head");this.removeClass(b,"stalk_blink")}else{clearInterval(this.blinkTimeout);this.blinkTimeout=setInterval(function(){var c=document.getElementById(STALK_window.rootDivName+"_head");if(STALK_window.hasClass(c,"stalk_blink")){STALK_window.removeClass(c,"stalk_blink")}else{STALK_window.addClass(c,"stalk_blink")}},1000)}},inputChatMessage:function(e,d){this.blinkHeader(true);if(e.keyCode==13&&!e.shiftKey){if(e.preventDefault){e.preventDefault()}else{e.returnValue=false}var c=d.value;c=c.replace(/^\s+|\s+$/g,"");if(c.length>0){STALK.sendMessage(encodeURIComponent(c));d.value="";d.style.height="30px";return false}}var b=d.clientHeight;var a=94;if(a>b){b=Math.max(d.scrollHeight,b);if(a){b=Math.min(a,b)}if(b>d.clientHeight){d.style.height=b+8+"px"}}else{d.style.overflow="auto"}},setChatMessage:function(c,d){var e=document.getElementById(this.rootDivName+"_content");var b=document.createElement("div");this.addClass(b,"stalk_message");var a="";if(c.link){a=a+'<span class="stalk_messagefrom"><a target="_blank" href="'+c.link+'" class="stalk_userlink" alt="GO TO User Page!">'+c.name+"</a>:&nbsp;&nbsp;</span>"}b.innerHTML='<span class="stalk_messagecontent">'+a+decodeURIComponent(d)+'</span>&nbsp;&nbsp;&nbsp;<span class="stalk_messagetime">'+this.getNowStr()+"</span>";e.appendChild(b);e.scrollTop=e.scrollHeight;if(document.getElementById(this.rootDivName+"_content").style.display!="block"){this.blinkHeader()}STALK_conf.isEmptyMessage=false},setSysMessage:function(b){var c=document.getElementById(this.rootDivName+"_content");var a=document.createElement("div");this.addClass(a,"stalk_message");a.innerHTML='<span class="stalk_systemcontent">'+this.getNowStr()+" - "+b+"</span>";c.appendChild(a);c.scrollTop=c.scrollHeight},toggleChatBoxGrowth:function(){if("OPTION_BUTTON"==this.eventType){this.eventType="";return false}this.blinkHeader(true);var b=document.getElementById(this.rootDivName+"_content");var a=document.getElementById(this.rootDivName);if(b.style.display=="none"){document.getElementById(this.rootDivName).style.width=this.divOpenWidth;document.getElementById(this.rootDivName+"_options").style.display="block";document.getElementById(this.rootDivName+"_size").style.display="block";document.getElementById(this.rootDivName+"_title").style["float"]="left";document.getElementById(this.rootDivName+"_title").style.textAlign="";document.getElementById(this.rootDivName+"_title").style.width="";document.getElementById(this.rootDivName+"_sitelink").style.display="block";document.getElementById(this.rootDivName+"_head").style.padding="7px 7px 7px 7px";b.style.display="block";if(this.isLogined){document.getElementById(this.rootDivName+"_login").style.display="none";document.getElementById(this.rootDivName+"_input").style.display="block"}else{document.getElementById(this.rootDivName+"_login").style.display="block";document.getElementById(this.rootDivName+"_input").style.display="none"}this.sizing()}else{document.getElementById(this.rootDivName).style.width=this.divCloseWidth;document.getElementById(this.rootDivName+"_title").style["float"]="";document.getElementById(this.rootDivName+"_title").style.textAlign="center";document.getElementById(this.rootDivName+"_title").style.width="100%";b.style.display="none";document.getElementById(this.rootDivName+"_login").style.display="none";document.getElementById(this.rootDivName+"_input").style.display="none";document.getElementById(this.rootDivName+"_options").style.display="none";document.getElementById(this.rootDivName+"_size").style.display="none";document.getElementById(this.rootDivName+"_input").style.display="none";document.getElementById(this.rootDivName+"_sitelink").style.display="none";if(this.isIE()){document.getElementById(this.rootDivName+"_head").style.padding="7px 0px 0px 0px"}}},setTitleMessage:function(a){var b=document.getElementById(this.rootDivName+"_title");b.innerHTML=a},logined:function(d){var c=document.getElementById(this.rootDivName+"_login");var b=document.getElementById(this.rootDivName+"_input");if(document.getElementById(this.rootDivName+"_content").style.display=="block"){c.style.display="none";b.style.display="block"}else{c.style.display="none";b.style.display="none"}document.getElementById(this.rootDivName+"_options").innerHTML='<a href="javascript:void(0)" onclick="javascript:return STALK.logout();" class="stalk_tooltip" title="Logout from '+d+'"><img src="'+this.imageServer+'/img/logout.png"></a>';var a=document.getElementById(this.rootDivName+"_textarea");if(b.style.display!="none"){a.focus()}a.value=a.value;this.isLogined=true;this.setSysMessage("logined with "+d)},logout:function(){if(!this.isIE()){this.eventType="OPTION_BUTTON"}var b=document.getElementById(this.rootDivName+"_login");var a=document.getElementById(this.rootDivName+"_input");if(document.getElementById(this.rootDivName+"_content").style.display=="block"){b.style.display="block";a.style.display="none"}else{b.style.display="none";a.style.display="none"}STALK_utils.delUserInfo();document.getElementById(this.rootDivName+"_options").innerHTML="";this.isLogined=false;this.setSysMessage("logout.")},sizing:function(a){if(a){if(!this.isIE()){this.eventType="OPTION_BUTTON"}this.currentSize=a}if(this.pageSize.width<=980){return}if(this.currentSize=="MIN"){document.getElementById(this.rootDivName+"_size").innerHTML='<a href="javascript:void(0)" onclick="javascript:return STALK.sizing(\'MAX\');" class="stalk_tooltip" title="Big Size"><img src="'+this.imageServer+'/img/max.png"></a>';document.getElementById(this.rootDivName).style.width=this.divOpenWidth}else{document.getElementById(this.rootDivName+"_size").innerHTML='<a href="javascript:void(0)" onclick="javascript:return STALK.sizing(\'MIN\');" class="stalk_tooltip" title="Small Size"><img src="'+this.imageServer+'/img/min.png"></a>';document.getElementById(this.rootDivName).style.width=this.divMaxOpenWidth}},getNowStr:function(){var d=new Date();var a=d.getHours();var b=d.getMinutes();if(b<10){b="0"+b}var c=a+":"+b+" ";if(a>11){c=c+"PM"}else{c=c+"AM"}return c},isIE:function(){return(/MSIE (\d+\.\d+);/.test(navigator.userAgent))}};var STALK=(function(e,g,a){var h=function(){g.loadJson(e.appUrl+"/node?refer="+e.refer,"STALK.callbackInit")};var c=function(){g.loadJson(e.appUrl+"/node?refer="+e.refer,"STALK.callbackSocketCallback")};var d=function(k){if(k.status!="ok"){return}e.serverInfo=k;a.initWin(e.divName,e.httpUrl);e.user=STALK_utils.getUserInfo();if(typeof e.user.target=="undefined"){e.isLogined=false}else{e.isLogined=true;a.logined(e.user.target)}g.loadScript("http://cdn.sockjs.org/sockjs-0.3.min.js",f)};var b=function(){};var f=function(k){if(k){if(k.status!="ok"){if(a.isShowRootDiv()){a.setSysMessage("I'm so sorry. Traffic jam right now.<br/> Please connect again later.")}return}e.serverInfo=k}a.showRootDiv(true);e.sock=new SockJS("http://"+e.serverInfo.host+":"+e.serverInfo.port+"/message");e.sock.onopen=function(m){var l={action:"JOIN",refer:e.refer,user:e.user};e.sock.send(JSON.stringify(l));e.__intvalId=setInterval(function(){if(e.isEmptyMessage&&e.currentUserCnt>=2){a.setChatMessage({}," * You can talk to each other! :) *");e.isEmptyMessage=false;clearInterval(e.__intvalId)}},200000);if(typeof _STALK_callback=="function"){_STALK_callback(e.refer)}};e.sock.onmessage=function(n){var m=JSON.parse(n.data);if(m.action=="JOIN"){e.socketId=m.socketId;e.currentUserCnt=m.count;a.setTitleMessage("ONLINE : "+e.currentUserCnt)}else{if(m.action=="IN"){e.currentUserCnt=m.count;a.setTitleMessage("ONLINE : "+e.currentUserCnt)}else{if(m.action=="LOGIN"){g.setUserInfo(m.user);e.isLogined=true;e.user=m.user;a.logined(e.user.target);var l={action:"JOIN",refer:e.refer,user:e.user};e.sock.send(JSON.stringify(l))}else{if(m.action=="LOGOUT"){e.currentUserCnt=m.count;a.setTitleMessage("ONLINE : "+e.currentUserCnt)}else{if(m.action=="OUT"){e.currentUserCnt=m.count;a.setTitleMessage("ONLINE : "+e.currentUserCnt)}else{if(m.action=="MESSAGE"){a.setChatMessage(m.user,m.message)}else{}}}}}}};e.sock.onclose=function(){c()}};var i=function(l){var k={action:"MESSAGE",refer:e.refer,user:e.user,message:l};e.sock.send(JSON.stringify(k))};var j=function(){var k={action:"LOGOUT",refer:e.refer,user:e.user};e.sock.send(JSON.stringify(k));a.logout();e.isLogined=false};return{init:function(l){if(e.isReady){return false}e.isReady=true;var k=location.pathname.substr(1);k="/"+B64.encode(k);e.refer=location.host+k;if(l){if(l.divName){e.divName=l.divName}if(l.refer){e.refer=l.refer}}if(e.refer){}else{return}h()},callbackInit:function(k){d(k)},callbackSocketCallback:function(k){f(k)},sendMessage:function(k){i(k)},callbackSendMessage:function(k){},logout:function(){j()},getOauthUrl:function(k){return e.appUrl+"/auth?target="+k+"&channel="+e.serverInfo.channel+"&socketId="+e.socketId+"&refer="+e.refer},sizing:function(k){a.sizing(k)}}})(STALK_conf,STALK_utils,STALK_window);var B64={alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",lookup:null,ie:/MSIE /.test(navigator.userAgent),ieo:/MSIE [67]/.test(navigator.userAgent),encode:function(h){var e=B64.toUtf8(h),c=-1,b=e.length,g,d,f=[,,,];if(B64.ie){var a=[];while(++c<b){g=e[c+1],d=e[c+2];f[0]=e[c]>>2;f[1]=((e[c]&3)<<4)|(e[++c]>>4);if(isNaN(g)){f[2]=f[3]=64}else{f[2]=((e[c]&15)<<2)|(e[++c]>>6);f[3]=(isNaN(d))?64:e[c]&63}a.push(B64.alphabet[f[0]],B64.alphabet[f[1]],B64.alphabet[f[2]],B64.alphabet[f[3]])}return a.join("")}else{a="";while(++c<b){g=e[c+1];d=e[c+2];f[0]=e[c]>>2;f[1]=((e[c]&3)<<4)|(e[++c]>>4);if(isNaN(g)){f[2]=f[3]=64}else{f[2]=((e[c]&15)<<2)|(e[++c]>>6);f[3]=(isNaN(d))?64:e[c]&63}a+=B64.alphabet[f[0]]+B64.alphabet[f[1]]+B64.alphabet[f[2]]+B64.alphabet[f[3]]}return a}},decode:function(d){var c=B64.fromUtf8(d),b=0,a=c.length;if(B64.ieo){result=[];while(b<a){if(c[b]<128){result.push(String.fromCharCode(c[b++]))}else{if(c[b]>191&&c[b]<224){result.push(String.fromCharCode(((c[b++]&31)<<6)|(c[b++]&63)))}else{result.push(String.fromCharCode(((c[b++]&15)<<12)|((c[b++]&63)<<6)|(c[b++]&63)))}}}return result.join("")}else{result="";while(b<a){if(c[b]<128){result+=String.fromCharCode(c[b++])}else{if(c[b]>191&&c[b]<224){result+=String.fromCharCode(((c[b++]&31)<<6)|(c[b++]&63))}else{result+=String.fromCharCode(((c[b++]&15)<<12)|((c[b++]&63)<<6)|(c[b++]&63))}}}return result}},toUtf8:function(e){var b=-1,a=e.length,d,c=[];if(/^[\x00-\x7f]*$/.test(e)){while(++b<a){c.push(e.charCodeAt(b))}}else{while(++b<a){d=e.charCodeAt(b);if(d<128){c.push(d)}else{if(d<2048){c.push((d>>6)|192,(d&63)|128)}else{c.push((d>>12)|224,((d>>6)&63)|128,(d&63)|128)}}}}return c},fromUtf8:function(e){var b=-1,a,c=[],d=[,,,];if(!B64.lookup){a=B64.alphabet.length;B64.lookup={};while(++b<a){B64.lookup[B64.alphabet[b]]=b}b=-1}a=e.length;while(b<a){d[0]=B64.lookup[e.charAt(++b)];d[1]=B64.lookup[e.charAt(++b)];c.push((d[0]<<2)|(d[1]>>4));d[2]=B64.lookup[e.charAt(++b)];if(d[2]==64){break}c.push(((d[1]&15)<<4)|(d[2]>>2));d[3]=B64.lookup[e.charAt(++b)];if(d[3]==64){break}c.push(((d[2]&3)<<6)|d[3])}return c}};